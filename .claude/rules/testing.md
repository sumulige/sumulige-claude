# Testing Rules

> 测试规则 - 所有代码必须遵守

## 核心原则

**测试先于代码**：使用 TDD 工作流，先写测试再实现。

## 覆盖率要求

| 代码类型 | 最低覆盖率 |
|---------|-----------|
| 普通业务逻辑 | 80% |
| 金融计算 | 100% |
| 认证逻辑 | 100% |
| 安全相关代码 | 100% |

## 提交前检查

每次提交前必须：

- [ ] 所有测试通过
- [ ] 覆盖率达标（80%+）
- [ ] 新功能有单元测试
- [ ] API 有集成测试
- [ ] 关键流程有 E2E 测试

```bash
# 提交前运行
npm test && npm run lint
```

## 测试类型要求

### 单元测试 (必须)

- 每个公共函数都有测试
- 测试边界情况（null, empty, max）
- 测试错误路径

### 集成测试 (必须)

- 每个 API 端点都有测试
- 测试正常响应和错误响应
- Mock 外部依赖

### E2E 测试 (关键流程)

- 登录/认证流程
- 核心业务流程
- 支付/金融流程

## 测试反模式 (禁止)

❌ **测试实现细节**
```typescript
// 不要测试内部状态
expect(component.state.count).toBe(5)
```

❌ **测试相互依赖**
```typescript
// 每个测试必须独立
test('creates user', () => { ... })
test('updates same user', () => { ... }) // 依赖前一个
```

❌ **固定等待**
```typescript
// 不要用固定时间等待
await page.waitForTimeout(5000)
```

## CI 集成

CI 流水线必须：

1. 运行所有单元测试
2. 运行所有集成测试
3. 运行 E2E 测试（关键流程）
4. 检查覆盖率阈值
5. 上传测试报告

## 相关命令

- `/tdd` - 测试驱动开发流程
- `/e2e` - E2E 测试生成
- `/test` - 运行测试
- `/test-coverage` - 覆盖率分析
