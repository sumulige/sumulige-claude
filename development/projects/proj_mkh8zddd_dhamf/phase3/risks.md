# Risk Assessment and Mitigation

**Project**: proj_mkh8zddd_dhamf (AI 代码审查工具)
**Date**: 1/17/2026
**Phase**: 3 - Planning
**Status**: In Progress

---

## Executive Summary

本文档识别 AI 代码审查工具项目的主要风险，并提供缓解策略。

**风险等级定义**:
- **Critical**: 可能导致项目失败
- **High**: 显著影响项目进度或质量
- **Medium**: 中等影响，需要监控
- **Low**: 轻微影响，可接受

**总体风险评级**: Medium (可控，需要积极管理)

---

## 1. LLM API Risks

### 1.1 API Service Unavailability

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-LLM-001 |
| **Title** | LLM API Service Downtime |
| **Category** | External Dependency |
| **Severity** | High |
| **Probability** | Medium |
| **Impact** | AI-enhanced analysis unavailable |

**Description**:
Claude API 或其他 LLM 服务可能出现中断、速率限制或服务降级，导致 AI 分析功能不可用。

**Mitigation Strategies**:

1. **Graceful Degradation**
   ```go
   func (s *Scanner) ScanWithAI(file string) Issues {
       issues, err := s.llm.Analyze(file)
       if err != nil {
           log.Warn("LLM unavailable, using rules only")
           return s.scanWithRules(file)  // Fallback to rules
       }
       return issues
   }
   ```

2. **Local Model Fallback**
   - 集成 Ollama 或本地 Llama 模型
   - 用户可配置首选模式 (API vs Local)

3. **Retry Logic**
   ```go
   retryConfig := retry.Config{
       MaxRetries: 3,
       Backoff:    exponentialBackoff,
       MaxDelay:   30 * time.Second,
   }
   ```

4. **Circuit Breaker**
   - 连续失败后暂停 API 调用
   - 自动恢复检测

**Monitoring**:
- API 可用性监控 (uptime robot)
- P95/P99 响应时间告警
- 失败率阈值告警 (>5%)

---

### 1.2 LLM Cost Overrun

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-LLM-002 |
| **Title** | Unexpected API Cost Increases |
| **Category** | Financial |
| **Severity** | High |
| **Probability** | Medium |
| **Impact** | Budget overrun, user dissatisfaction |

**Description**:
LLM API 调用成本可能超出预期，特别是在处理大型代码库时。

**Mitigation Strategies**:

1. **Cost Control Configuration**
   ```yaml
   ai:
     cost_control:
       max_requests_per_scan: 10
       max_tokens_per_scan: 10000
       monthly_budget_usd: 50.0
       warn_at_percent: 80
   ```

2. **Smart Sampling**
   - 只对最复杂的代码使用 LLM
   - 优先分析新变更的文件 (diff mode)

3. **Token Estimation**
   ```go
   func EstimateTokens(code string) int {
       return len(code) / 4  // Rough estimate: 4 chars per token
   }

   func CheckBudget(scan *Scan) error {
       estimated := EstimateTokens(scan.Code) * CostPerToken
       if estimated > remainingBudget {
           return errors.New("exceeds budget")
       }
       return nil
   }
   ```

4. **Local-First Architecture**
   - 默认使用规则引擎 (无成本)
   - AI 作为可选增强功能

**Monitoring**:
- 每日 API 成本报告
- 按用户/项目成本追踪
- 月度预算告警

---

### 1.3 LLM Accuracy Issues

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-LLM-003 |
| **Title** | False Positives/Negatives from AI |
| **Category** | Quality |
| **Severity** | Medium |
| **Probability** | Medium |
| **Impact** | User trust erosion |

**Description**:
LLM 可能产生不准确的分析结果，导致误报或漏报。

**Mitigation Strategies**:

1. **Dual-Validation System**
   ```
   Rule Engine (High Precision)
         ↓
   Filter Results
         ↓
   LLM Enhancement (Recall Boost)
         ↓
   Human Review (Final)
   ```

2. **Confidence Scoring**
   ```go
   type Issue struct {
       Confidence float64  // 0.0 to 1.0
       Source     string   // "rule" or "llm"
   }

   func (i *Issue) IsReliable() bool {
       return i.Confidence > 0.7 || i.Source == "rule"
   }
   ```

3. **Feedback Loop**
   - 用户可标记"不有用"的建议
   - 反馈数据用于改进 Prompt
   - A/B 测试不同 Prompt 版本

4. **Transparent Attribution**
   ```
   [AI-Generated] SQL Injection Risk (Confidence: 0.65)
   This suggestion was generated by AI and should be verified.
   ```

**Monitoring**:
- 用户"不有用"点击率
- 误报率抽样检查
- 准确率趋势分析

---

## 2. Performance Risks

### 2.1 Large Repository Scan Time

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-PERF-001 |
| **Title** | Scanning Large Repositories Takes Too Long |
| **Category** | Performance |
| **Severity** | High |
| **Probability** | High |
| **Impact** | Poor user experience, CI/CD blocking |

**Description**:
大型代码库 (100万+ 行) 扫描时间可能超过 5 分钟目标，影响 CI/CD 流水线。

**Mitigation Strategies**:

1. **Incremental Scanning**
   ```go
   func (s *Scanner) GetChangedFiles(base, head string) ([]string, error) {
       // Git diff to get only changed files
       return git.Diff(base, head, "--name-only")
   }
   ```

2. **Parallel Processing**
   ```go
   func (s *Scanner) ScanParallel(files []string) Issues {
       var wg sync.WaitGroup
       results := make(chan Issues, len(files))

       workers := runtime.NumCPU()
       for i := 0; i < workers; i++ {
           wg.Add(1)
           go func() {
               defer wg.Done()
               for file := range filesCh {
                   results <- s.ScanFile(file)
               }
           }()
       }
       // ...
   }
   ```

3. **Intelligent Caching**
   ```
   Cache Key: hash(file_path + file_content + rule_version)
   TTL: 24 hours or until file changes
   ```

4. **Progressive Output**
   ```bash
   $ smc-review scan ./src
   Scanning... [████████░░░░] 80% (452/567 files)
   Found 12 issues so far...
   ```

5. **Scan Targets**
   - 默认: Git diff only (CI mode)
   - 可选: Full scan (manual mode)

**Monitoring**:
- 按代码库大小扫描时间基准
- P95 扫描时间告警
- 缓存命中率追踪

---

### 2.2 Memory Exhaustion

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-PERF-002 |
| **Title** | High Memory Usage During Scans |
| **Category** | Performance |
| **Severity** | Medium |
| **Probability** | Low |
| **Impact** | Process crashes, system slowdown |

**Description**:
解析大型文件或并发扫描可能导致内存溢出。

**Mitigation Strategies**:

1. **Streaming Parsing**
   ```go
   func ParseFileStream(path string) (<-chan *ASTNode, error) {
       // Emit AST nodes as they're parsed
       // instead of loading entire tree into memory
   }
   ```

2. **File Size Limits**
   ```yaml
   scan:
     max_file_size_mb: 1.0
     skip_large_files: true
   ```

3. **Memory Monitoring**
   ```go
   func CheckMemoryLimit() {
       var m runtime.MemStats
       runtime.ReadMemStats(&m)
       if m.Alloc > maxMemory {
           log.Warn("Memory limit reached, flushing cache")
           cache.Flush()
       }
   }
   ```

4. **Worker Pool Limits**
   ```go
   const maxWorkers = 4
   semaphore := make(chan struct{}, maxWorkers)
   ```

**Monitoring**:
- 峰值内存使用追踪
- OOM 崩溃监控
- 内存泄漏检测

---

## 3. Quality Risks

### 3.1 High False Positive Rate

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-QUAL-001 |
| **Title** | Too Many False Positives |
| **Category** | Quality |
| **Severity** | High |
| **Probability** | Medium |
| **Impact** | User abandonment, tool ignored |

**Description**:
过多误报会导致用户忽略所有警告，使工具失去价值。

**Mitigation Strategies**:

1. **Strict Rule Defaults**
   ```yaml
   rules:
     security:
       enabled: true
       severity: high  # Only report high+
     quality:
       enabled: true
       severity: medium  # Only report medium+
   ```

2. **Smart Filtering**
   ```go
   func ShouldReport(issue Issue) bool {
       // Ignore in test files
       if isTestFile(issue.File) && issue.Severity < High {
           return false
       }
       // Ignore in generated code
       if isGenerated(issue.File) {
           return false
       }
       return true
   }
   ```

3. **User Feedback Integration**
   ```yaml
   ignore:
     issues:
       - id: long-function
         files: ["**/test_*.py"]
         reason: "Tests can be longer"
   ```

4. **Accuracy Metrics**
   - 定期人工抽样验证
   - 准确率目标: >85%
   - 误报率目标: <15%

**Monitoring**:
- 每周准确率报告
- 用户反馈分析
- 规则效果排行

---

### 3.2 Rule Coverage Gaps

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-QUAL-002 |
| **Title** | Missing Important Rules |
| **Category** | Quality |
| **Severity** | Medium |
| **Probability** | Medium |
| **Impact** | Limited value, missed vulnerabilities |

**Description**:
v1.0 可能缺少关键安全规则，导致漏报重要漏洞。

**Mitigation Strategies**:

1. **Competitive Analysis**
   - 对照 SonarQube, ESLint, Pylint 规则集
   - 识别高优先级缺失规则

2. **OWASP Top 10 Coverage**
   ```go
   var owaspRules = []Rule{
       SQLInjection{},
       XSS{},
       CSRFProtection{},
       InsecureDeserialization{},
       SecurityHeaders{},
       // ...
   }
   ```

3. **Community Contributions**
   - 开放规则提交流程
   - 自定义规则 DSL

4. **Phased Rollout**
   ```
   v1.0: Core security (SQLi, XSS)
   v1.1: OWASP Top 10 complete
   v1.2: Advanced security patterns
   ```

**Monitoring**:
- 规则覆盖率追踪
- 用户请求的新规则
- 漏报报告分析

---

## 4. Technical Risks

### 4.1 Tree-sitter Integration Complexity

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-TECH-001 |
| **Title** | Tree-sitter Go Binding Issues |
| **Category** | Technical |
| **Severity** | Medium |
| **Probability** | Medium |
| **Impact** | Delayed parsing, buggy AST |

**Description**:
Tree-sitter Go 绑定可能不成熟或有 bug，影响解析稳定性。

**Mitigation Strategies**:

1. **Alternative Parsers**
   ```go
   type Parser interface {
       Parse(path string) (*AST, error)
   }

   type TreeSitterParser struct{}
   type FallbackParser struct{}  // Regex/heuristic fallback
   ```

2. **Language-Specific Handling**
   ```go
   func ParseFile(path string) (*AST, error) {
       lang := DetectLanguage(path)
       switch lang {
       case Python:
           return parsePython(path)
       case JavaScript:
           return parseJavaScript(path)
       default:
           return nil, ErrUnsupported
       }
   }
   ```

3. **Error Recovery**
   ```go
   func ParseWithRecovery(code string) (*AST, []error) {
       ast, err := treeSitter.Parse(code)
       if err != nil {
           // Try partial parse
           ast, warnings = treeSitter.ParseRecover(code)
           return ast, warnings
       }
       return ast, nil
   }
   ```

4. **Early Prototyping**
   - Week 1: Verify Tree-sitter Go bindings
   - Week 2: Build minimal parser for each language

**Monitoring**:
- 解析失败率统计
- 按语言错误率追踪
- 性能基准对比

---

### 4.2 Database Migration Issues

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-TECH-002 |
| **Title** | Database Schema Migration Failures |
| **Category** | Technical |
| **Severity** | Low |
| **Probability** | Low |
| **Impact** | Data loss, upgrade failures |

**Description**:
数据库迁移失败可能导致用户数据丢失或升级中断。

**Mitigation Strategies**:

1. **Versioned Migrations**
   ```sql
   -- migrations/001_initial.up.sql
   CREATE TABLE scans (...);

   -- migrations/001_initial.down.sql
   DROP TABLE scans;
   ```

2. **Automated Testing**
   ```go
   func TestMigrations(t *testing.T) {
       db := testDB()
       MigrateUp(db)
       // Verify schema
       MigrateDown(db)
       // Verify clean state
   }
   ```

3. **Backup Before Migration**
   ```go
   func MigrateWithBackup(db *DB) error {
       backupPath := backup(db)
       defer func() {
           if err != nil {
               restore(db, backupPath)
           }
       }()
       return migrate(db)
   }
   ```

4. **SQLite Fallback**
   - 轻量级部署可使用 SQLite
   - 避免数据库安装问题

**Monitoring**:
- 迁移成功率监控
- 回滚事件追踪
- 用户报告的迁移问题

---

## 5. Security Risks

### 5.1 Code Privacy Leakage

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-SEC-001 |
| **Title** | User Code Sent to External API |
| **Category** | Security |
| **Severity** | Critical |
| **Probability** | Low |
| **Impact** | Legal liability, user trust loss |

**Description**:
用户代码可能被意外发送到外部 LLM API，违反隐私承诺。

**Mitigation Strategies**:

1. **Opt-In AI by Default**
   ```yaml
   ai:
     enabled: false  # Explicit opt-in required
   ```

2. **Clear Warnings**
   ```bash
   $ smc-review scan --ai
   ⚠️  WARNING: AI mode will send code snippets to external API.
   Confirm? (y/N):
   ```

3. **Code Sanitization**
   ```go
   func SanitizeForAI(code string) string {
       // Remove literals that might be secrets
       re := regexp.MustCompile(`['"][A-Za-z0-9/+]{32,}['"]`)
       return re.ReplaceAllString(code, `"***REDACTED***"`)
   }
   ```

4. **Audit Logging**
   ```go
   log.Info("AI request",
       "scan_id", scanID,
       "snippet_length", len(snippet),
       "contains_secrets", containsSecrets(snippet),
   )
   ```

5. **Local-Only Mode Guarantee**
   ```bash
   $ smc-review scan --local-only
   ✅ Local mode confirmed: No external API calls will be made.
   ```

**Monitoring**:
- AI 调用审计日志
- 异常数据量告警
- 定期隐私审计

---

### 5.2 Supply Chain Attacks

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-SEC-002 |
| **Title** | Malicious Dependency Injection |
| **Category** | Security |
| **Severity** | High |
| **Probability** | Low |
| **Impact** | User compromise, reputational damage |

**Description**:
恶意 Go 依赖可能被注入到项目中。

**Mitigation Strategies**:

1. **Go Modules Verification**
   ```bash
   go mod verify
   go mod tidy -compat
   ```

2. **Dependabot Integration**
   ```yaml
   # .github/dependabot.yml
   version: 2
   dependencies:
     - package-ecosystem: "gomod"
       directory: "/"
       schedule:
         interval: "weekly"
   ```

3. **SBOM Generation**
   ```bash
   go install github.com/anchore/syft/cmd/syft@latest
   syft . -o spdx-json > sbom.json
   ```

4. **Minimal Dependencies**
   - 审查每个新依赖
   - 优先使用标准库

**Monitoring**:
- 依赖更新通知
- 安全漏洞扫描 (govulncheck)
- 依赖审查流程

---

## 6. Project Risks

### 6.1 Timeline Overrun

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-PROJ-001 |
| **Title** | Development Takes Longer Than Expected |
| **Category** | Project Management |
| **Severity** | Medium |
| **Probability** | Medium |
| **Impact** | Delayed launch, missed opportunity |

**Description**:
开发复杂度被低估，导致 16 周计划延期。

**Mitigation Strategies**:

1. **MVP Prioritization**
   ```
   Must Have for v1.0:
   - Python/JS parsing
   - Core security rules
   - CLI tool
   - GitHub Action

   Can Defer to v1.1:
   - IDE plugins
   - Advanced rules
   - Local LLM optimization
   ```

2. **Weekly Checkpoints**
   - 每周进度回顾
   - 识别阻塞项
   - 调整优先级

3. **Buffer Time**
   - WBS 中已包含 3.5 周缓冲
   - 非关键路径可压缩

4. **Parallel Work**
   - 规则开发可与 CLI 并行
   - 文档可与测试并行

**Monitoring**:
- 燃尽图 (Burndown chart)
- 里程碑达成率
- 关键路径进度

---

### 6.2 Skill Gaps

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-PROJ-002 |
| **Title** | Required Skills Not Available |
| **Category** | Resource |
| **Severity** | Medium |
| **Probability** | Low |
| **Impact** | Quality issues, delays |

**Description**:
团队可能缺少 Go、AST 或 LLM 集成经验。

**Mitigation Strategies**:

1. **Learning Phase**
   - Week 0: 技术调研和原型
   - 40 小时专门用于学习

2. **Code Reuse**
   - 参考开源项目 (SonarQube, golangci-lint)
   - 使用成熟的库

3. **External Help**
   - Stack Overflow / GitHub Issues
   - Gopher社区 Slack
   - AI 辅助编程

4. **Incremental Complexity**
   ```
   Start: Simple regex rules
   Then: AST-based rules
   Finally: Complex semantic analysis
   ```

**Monitoring**:
- 阻塞问题追踪
- 学习进度记录
- 外部帮助频率

---

## 7. Market Risks

### 7.1 Competitor Response

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-MKT-001 |
| **Title** | Existing Competitors Add Similar Features |
| **Category** | Market |
| **Severity** | Medium |
| **Probability** | Medium |
| **Impact** | Reduced differentiation |

**Description**:
SonarQube 或 GitHub Copilot 可能添加类似功能。

**Mitigation Strategies**:

1. **Focus on Niche**
   - 本地部署优先
   - AI + Rules 混合方法
   - 开源透明

2. **Fast Iteration**
   - 快速响应用户反馈
   - 社区驱动功能

3. **Unique Features**
   ```
   Differentiators:
   - Single binary, easy installation
   - Works offline by default
   - Transparent rule explanations
   - Affordable for small teams
   ```

4. **Community Building**
   - 开源核心功能
   - 贡献者友好的架构

**Monitoring**:
- 竞品功能追踪
- 用户反馈分析
- 差异化价值验证

---

### 7.2 Low Adoption

| Attribute | Value |
|-----------|-------|
| **Risk ID** | R-MKT-002 |
| **Title** | Users Don't Adopt the Tool |
| **Category** | Market |
| **Severity** | High |
| **Probability** | Medium |
| **Impact** | Project failure |

**Description**:
目标用户不愿意切换现有工具。

**Mitigation Strategies**:

1. **Smooth Onboarding**
   ```bash
   # One-line install
   curl https://smc-review.sh/install | sh

   # Auto-config detection
   smc-review init --detect-project-type
   ```

2. **Integration First**
   - GitHub Action 无需安装
   - 与现有 CI/CD 兼容

3. **Free & Open Source**
   - MIT 许可证
   - 核心功能永久免费

4. **Early User Feedback**
   - Alpha 测试计划
   - Beta 用户访谈

**Monitoring**:
- 下载量追踪
- 活跃用户指标
- 留存率分析
- NPS 调查

---

## 8. Risk Register Summary

| Risk ID | Title | Severity | Probability | Mitigation Status |
|---------|-------|----------|-------------|-------------------|
| R-LLM-001 | LLM API Downtime | High | Medium | Planned |
| R-LLM-002 | Cost Overrun | High | Medium | Planned |
| R-LLM-003 | Accuracy Issues | Medium | Medium | Planned |
| R-PERF-001 | Large Scan Time | High | High | In Progress |
| R-PERF-002 | Memory Exhaustion | Medium | Low | Planned |
| R-QUAL-001 | False Positives | High | Medium | Planned |
| R-QUAL-002 | Rule Gaps | Medium | Medium | Planned |
| R-TECH-001 | Tree-sitter Issues | Medium | Medium | In Progress |
| R-TECH-002 | Migration Failures | Low | Low | Planned |
| R-SEC-001 | Privacy Leakage | Critical | Low | In Progress |
| R-SEC-002 | Supply Chain | High | Low | Planned |
| R-PROJ-001 | Timeline Overrun | Medium | Medium | Monitored |
| R-PROJ-002 | Skill Gaps | Medium | Low | Addressed |
| R-MKT-001 | Competitor Response | Medium | Medium | Monitored |
| R-MKT-002 | Low Adoption | High | Medium | Planned |

---

## 9. Risk Review Process

### 9.1 Frequency

| Review Type | Frequency | Participants |
|-------------|-----------|--------------|
| Daily Standup | Daily | Development team |
| Risk Review | Weekly | Project lead |
| Stakeholder Update | Bi-weekly | All stakeholders |
| Full Assessment | Monthly | All stakeholders |

### 9.2 Risk Triggers

| Trigger | Action |
|---------|--------|
| New risk identified | Add to register, assess severity |
| Risk status changes | Update register, notify stakeholders |
| Mitigation completed | Mark resolved, document lessons |
| Risk materialized | Incident response, post-mortem |

### 9.3 Escalation Matrix

| Severity | Immediate Action | Escalation Timeline |
|----------|------------------|---------------------|
| Critical | Stop the line | Immediate |
| High | Daily review | 24 hours |
| Medium | Weekly review | 1 week |
| Low | Monthly review | Next review |

---

## 10. Contingency Plans

### 10.1 If LLM API Becomes Unreliable

1. **Week 1-2**: Document local model setup guide
2. **Week 3-4**: Prioritize rule engine accuracy
3. **Week 5-6**: Release "Rules Only" mode as default

### 10.2 If Timeline Slips Significantly

1. **Cut P2 Features**: Move IDE plugin, advanced rules to v1.1
2. **Reduce Scope**: Support only Python (delay JS/TS)
3. **Extend Timeline**: Communicate 4-week delay to stakeholders

### 10.3 If Adoption Is Lower Than Expected

1. **Pivot**: Focus on enterprise/local deployment
2. **Partnership**: Integrate with existing platforms
3. **Community**: Launch open-source contribution campaign

---

## Next Steps

1. Review risk register with stakeholders
2. Assign risk owners
3. Set up monitoring and alerting
4. Schedule first risk review meeting
5. All Phase 3 documents complete - ready for Phase 4

---

## Metadata

- **Created**: 1/17/2026
- **Author**: Phase 3 Design Executor
- **Total Risks**: 15
- **Critical Risks**: 1
- **High Risks**: 7
- **Medium Risks**: 6
- **Low Risks**: 1
- **Status**: Draft for Review
- **Related Docs**: All Phase 3 documents

---

*This risk assessment document provides a comprehensive view of potential threats to the AI Code Review Tool project and strategies to mitigate them.*
